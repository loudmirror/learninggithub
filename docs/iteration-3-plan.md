# Iteration 3 计划：问答功能与体验优化

> **目标**: 实现围绕单仓库的上下文问答能力，优化学习路径体验

**开始时间**: 2025-11-21
**预计时长**: 4-5 天
**依赖**: Iteration 2 (已完成)

---

## 📋 背景

Iteration 2 已完成 GitHub API 集成、代码分析和 AI 学习路径生成。Iteration 3 将增加问答功能，让用户在学习过程中可以提问并获得基于项目代码的解答。

### 当前技术栈

- **后端**: FastAPI + Python
- **GitHub API**: PyGithub
- **代码分析**: 项目类型、依赖、结构分析
- **AI 生成**: OpenAI GPT-4 Turbo
- **缓存**: 文件系统缓存

### Iteration 3 技术方案

由于当前没有向量化/RAG 基础设施，我们将采用**简化方案**：

1. **问答服务**: 基于 OpenAI API，结合代码分析结果和 GitHub 文件内容
2. **上下文构建**: 使用代码分析结果 + 关键文件内容
3. **会话管理**: 内存存储，支持多轮对话
4. **前端集成**: 添加问答 UI 组件

---

## 🎯 Story 列表

| Story | 标题 | 预估 | 优先级 | 状态 |
|-------|------|------|--------|------|
| 3.1 | 问答服务实现 | 2-3天 | High | 待开始 |
| 3.2 | 问答 UI 集成 | 1-2天 | High | 待开始 |
| 3.3 | 学习路径 UX 优化 | 1天 | Medium | 待开始 |

---

## Story 3.1: 问答服务实现

### 目标

实现基于 OpenAI 的问答服务，支持用户提问并获得基于项目代码的回答。

### 功能需求

1. **问答 API 端点**
   - `POST /api/qa/ask` - 提问
   - `GET /api/qa/history/{session_id}` - 获取会话历史
   - `DELETE /api/qa/session/{session_id}` - 删除会话

2. **问题理解**
   - 提取问题关键词
   - 识别问题类型（how-to, what, why）
   - 提取代码实体（函数名、类名）

3. **上下文构建**
   - 获取代码分析结果
   - 读取相关文件内容（README, 配置文件等）
   - 结合用户当前学习位置

4. **AI 回答生成**
   - 构建包含上下文的 Prompt
   - 调用 OpenAI API 生成回答
   - 支持多轮对话（会话历史）

5. **会话管理**
   - 会话 ID 生成
   - 会话历史存储（内存）
   - 会话过期管理（30分钟）

### 技术实现

#### 1. 数据模型 (`app/schemas/qa.py`)
```python
- AskQuestionRequest: 问题请求
- QAResponse: 问答响应
- CodeReference: 代码引用
- ConversationHistory: 会话历史
```

#### 2. 核心服务

**QuestionAnalyzer** (`app/services/question_analyzer.py`)
- 问题类型识别
- 关键词提取
- 代码实体提取

**QAPromptBuilder** (`app/services/qa_prompt_builder.py`)
- 系统 Prompt 定义
- 上下文 Prompt 构建
- 会话历史整合

**SessionManager** (`app/services/session_manager.py`)
- 会话创建和管理
- 消息添加和检索
- 过期会话清理

**QAService** (`app/services/qa_service.py`)
- 服务编排
- 调用 GitHub API 获取文件
- 调用 AI 生成回答
- 返回格式化响应

#### 3. API 路由 (`app/api/routes/qa.py`)
```python
POST /api/qa/ask
GET /api/qa/history/{session_id}
DELETE /api/qa/session/{session_id}
```

### 验收标准

- ✅ 用户可以提问并获得回答
- ✅ 回答基于项目实际代码
- ✅ 支持多轮对话（保留上下文）
- ✅ 响应时间 < 5 秒
- ✅ 错误处理完善

---

## Story 3.2: 问答 UI 集成

### 目标

在 Tutorial 页面添加问答面板，让用户可以提问。

### 功能需求

1. **问答面板组件**
   - 输入框
   - 消息列表（用户 + AI）
   - Loading 状态
   - 错误提示

2. **交互功能**
   - 发送问题
   - 显示回答（支持 Markdown）
   - 会话管理
   - 代码引用跳转

3. **UI 优化**
   - 响应式布局
   - 代码高亮
   - 滚动到最新消息

### 验收标准

- ✅ 问答面板正常显示
- ✅ 可以发送问题并获得回答
- ✅ Markdown 渲染正确
- ✅ 代码块语法高亮
- ✅ 移动端适配良好

---

## Story 3.3: 学习路径 UX 优化

### 目标

优化学习路径的交互体验，让用户更容易理解和跟随。

### 优化内容

1. **模块折叠优化**
   - 默认只展开当前模块
   - 完成的模块显示✓
   - 未开始的模块折叠

2. **步骤状态优化**
   - 更清晰的状态图标
   - 进度百分比显示
   - 下一步提示

3. **视觉层级优化**
   - 调整间距和留白
   - 优化颜色和对比度
   - 改进可读性

### 验收标准

- ✅ 用户测试反馈良好
- ✅ 不会迷失当前位置
- ✅ 主要信息一目了然

---

## 📈 关键指标

### 开发指标

- **新增代码**: 预计 ~1,500 行
- **核心服务**: 4 个新服务
- **API 端点**: 3 个
- **前端组件**: 2-3 个

### 性能指标

- **问答响应**: < 5 秒
- **会话管理**: 支持 10+ 并发会话
- **内存使用**: 合理控制

---

## 🚀 实施计划

### Week 1

**Day 1-2: Story 3.1 - 后端问答服务**
- 创建数据模型
- 实现问题分析器
- 实现 Prompt 构建器
- 实现会话管理

**Day 3: Story 3.1 - API 和测试**
- 实现 QA 服务编排
- 创建 API 路由
- 单元测试
- 集成测试

**Day 4-5: Story 3.2 - 前端集成**
- 创建问答组件
- API 调用集成
- UI 优化

**Day 6: Story 3.3 - UX 优化**
- 学习路径交互优化
- 用户测试
- 问题修复

---

## 📝 技术决策

### 1. 为什么不用向量化/RAG？

**原因**:
- Iteration 2 未实现向量化基础设施
- 简化 MVP，降低复杂度
- OpenAI API 已足够支持问答

**替代方案**:
- 使用代码分析结果作为上下文
- 读取关键文件内容
- 结合学习位置提供针对性回答

### 2. 会话存储方式

**选择**: 内存存储

**原因**:
- MVP 阶段，简单高效
- 重启后会话丢失可接受
- 后续可升级到 Redis

### 3. AI 模型选择

**选择**: GPT-4 Turbo

**原因**:
- 更准确的代码理解
- 更好的中文支持
- 成本可接受（问答频率不高）

---

## 🎯 成功标准

### 功能完整性

- ✅ 所有 3 个 Story 完成
- ✅ API 文档齐全
- ✅ 测试覆盖率 > 80%

### 用户体验

- ✅ 问答功能可用且有价值
- ✅ 学习路径易于跟随
- ✅ 无明显卡顿或错误

### 代码质量

- ✅ 符合编码规范
- ✅ 结构清晰，易于维护
- ✅ 完整的错误处理

---

## 🔗 相关文档

- [Iteration 2 进度](./iteration-2-progress.md)
- [Story 3.1: 问答服务](./stories/story-3.1-qa-service.md)
- [Story 3.2: 问答 UI](./stories/story-3.2-qa-ui-integration.md)
- [Story 3.3: UX 优化](./stories/story-3.3-learning-path-ux-optimization.md)

---

**创建时间**: 2025-11-21
**最后更新**: 2025-11-21
**状态**: 进行中
